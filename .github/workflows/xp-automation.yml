name: XP Automation

on:
  schedule:
    - cron: '5 */4 * * *'  # Runs every 4 hours at minute 5 (UTC)
  workflow_dispatch:        # Allows manual triggering

permissions:
  contents: write  # 'write' to commit dashboard image

jobs:
  send-xp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Puppeteer
        run: |
          npm install puppeteer

      - name: Generate Dashboard Image
        run: |
          node -e "
          const puppeteer = require('puppeteer');
          (async () => {
            const browser = await puppeteer.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();
            await page.setViewport({width: 800, height: 400});
            await page.goto('file://' + process.cwd() + '/dashboard.html', {waitUntil: 'networkidle2'});
            await page.waitForTimeout(2000); // Wait for animations to load
            await page.screenshot({path: 'dashboard.png', type: 'png'});
            await browser.close();
            console.log('Dashboard image generated successfully!');
          })();
          "

      - name: Run XP request
        run: |
          echo "ðŸ“¤ Sending XP request..."
          RESPONSE=$(curl --ssl-no-revoke -s -X POST https://api.duolingopro.net/request \
            -H "Authorization: Bearer ${{ secrets.DUOLINGO_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"gain_type": "xp", "amount": 30000}')
          echo "ðŸ“¨ Response from server:"
          echo "$RESPONSE"

      - name: Commit and push dashboard image
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add dashboard.png
          git diff --staged --quiet || git commit -m "Update dashboard image [automated]"
          git push